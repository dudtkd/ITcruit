<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>

<!-- Page main content START -->
<div class="page-content-wrapper border">
    <!-- Title -->
    <sec:authorize access="isAuthenticated()">
   		<sec:authentication property="principal.account.accountId" var="aId"/>
	</sec:authorize>
    <div class="row mb-3">
        <div class="col-12 d-sm-flex justify-content-between align-items-center">
            <h1 class="h5 mb-2 mb-sm-0">관심기업</h1>
        </div>
    </div>

    <!-- Courses Row START -->
    <div class="row g-4">
        <!-- Course information START -->
        <div class="col-lg-6">
            <div class="card bg-transparent border rounded-3 h-100">
                <div class="card-header bg-light border-bottom">
                    <h5 class="h6 card-header-title">기업 목록</h5>
                </div>
                					<!-- Card body START -->
					<div class="card-body pb-0">
						<!-- Table START -->
						<div class="table-responsive border-0">
							<c:set value="${likeEntPagingVO.dataList }" var="entList"/>
							<table class="table align-middle p-4 mb-0 table-hover" style="text-align: center;">
								<thead style="background-color: #DCD8FC;">
									<tr>
										<th scope="col" class="col-4 rounded-start" style="color: black;">기업명</th> <!-- 폭 줄임 -->
										<th scope="col" class="col-4" style="color: black;">채용공고</th> <!-- 폭 줄임 -->
										<th scope="col" class="col-4 rounded-end" style="color: black;">관심기업 해제</th> <!-- 폭 줄임 -->
									</tr>
								</thead>
								<c:choose>
								<c:when test="${empty entList }">
									<tr>
										<td colspan='4'> <span>관심 기업이 등록되지 않았습니다</span> </td>
									</tr>
								</c:when>
								<c:otherwise>
									<tbody>
										<c:forEach items="${entList }" var="entList">
											<!-- Table row -->
											<tr>
												<!-- Table data -->
												<td> <a href="#" class="selectEnt" data-entno=${entList.entNo } style="color: gray; text-decoration: none;" onmouseover="this.style.color='#3399FF';" onmouseout="this.style.color='gray';"> <span style="font-weight: bold;"> ${entList.entNm } </span> </a></td>
												<!-- Table data -->
												<td> <span style="font-weight: bold;"> ${entList.recruitCount } 개 진행중</span></td>
												<!-- Table data -->
												<td>
													<button class="btn btn-sm btn-danger mb-0 deleteBtn"
														data-entno=${entList.entNo }>해제</button>
												</td>
											</tr>
										</c:forEach>
									</tbody>
								</c:otherwise>
							</c:choose>
							</table>
						</div>
						<!-- Table END -->
						<form method="post" id="likeEntListForm">
							<input type="hidden" id="likeEntListPage" name="likeEntListPage">
							<sec:csrfInput/>
						</form>
						<div id="likeEntListPagingArea" class="d-sm-flex justify-content-sm-between align-items-sm-center mt-1 mt-sm-0">
						<p class="mb-0 text-center text-sm-start"></p>
						${likeEntPagingVO.pagingHTML }
						</div>
					</div>
					<!-- Card body END -->
            </div>
        </div>
        <!-- Course information START -->
        <div class="col-lg-6">
            <div class="card bg-transparent border rounded-3 h-100">
                <div class="card-header bg-light border-bottom">
                    <h5 class="h6 card-header-title">공고 정보</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                           <a id="detail"> <img id="entImg" src="#" class="rounded" alt=""> </a>
                        </div>
                    </div>
					<div class="card-body pb-0">
						<!-- Table START -->
						<div class="table-responsive border-0">
							<table class="table align-middle p-4 mb-0 table-hover" id="recruitTable">
								
									
										<tbody>
										<tr id="emptyRecruit">
											
										</tr>
												
											
										</tbody>
									
							</table>
						</div>
						<!-- Table END -->
<!-- 						<form method="post" id="likeEntListForm"> -->
<!-- 							<input type="hidden" id="likeEntListPage" name="likeEntListPage"> -->
<%-- 							<sec:csrfInput /> --%>
<!-- 						</form> -->
<!-- 						<div id="likeEntListPagingArea" -->
<!-- 							class="d-sm-flex justify-content-sm-between align-items-sm-center mt-1 mt-sm-0"> -->
<!-- 							<p class="mb-0 text-center text-sm-start"></p> -->
<%-- 							${likeEntPagingVO.pagingHTML } --%>
<!-- 						</div> -->
<!-- 					</div> -->
<!-- 					Card body END -->


				</div>
            </div>
        </div>
        <!-- Course information END -->
    </div>
    <!-- Courses Row END -->
</div>








		<!-- 이력서 모달 -->
        <div class="modal fade twm-saved-jobs-view" id="resumeView" aria-hidden="true" aria-labelledby="saved_job_view" tabindex="-1">
	
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form>
    
                        <div class="modal-header">
                            <h2 class="modal-title" id="saved_job_view">ITcruit</h2>
                            <div>이력서를 선택해주세요.</div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
    
                        <div class="modal-body" id="resumeModalBody">
                            
                        </div>
    
                        <div class="modal-footer">
                            <button type="button" class="btn btn-info site-button" data-bs-dismiss="modal">확인</button>
                        </div>
    
                    </form>
                </div>
            </div>
            
        </div>
        <form id="resumeForm" action="/resume/registerView" method="post">
        	<input type="hidden" name="accounId" id="accountId" value="${aId }">
        <sec:csrfInput/>
        </form>
	
	<div class="modal fade" id="pdfModal" tabindex="-1" role="dialog" aria-labelledby="pdfModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-xl" role="document"> <!-- 크기를 'modal-xl'로 설정 -->
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="pdfModalLabel">PDF Viewer</h5>
	               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <iframe id="pdfViewer" style="width:100%; height:800px;"></iframe> <!-- 높이를 증가 -->
	            </div>
	        </div>
	    </div>
	</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
<script type="text/javascript">
$(function(){
	
	
	var likeEntListPagingArea = $("#likeEntListPagingArea");
	var likeEntListForm = $("#likeEntListForm");
	
	likeEntListPagingArea.on("click", "a" ,function(e){
		e.preventDefault();
		var likeEntListPagingNo = $(this).data("recruitminipage");
		likeEntListForm.find("#likeEntListPage").val(likeEntListPagingNo);
		likeEntListForm.submit();
	})
	
	
	$('.deleteBtn').on("click",function(){
		
		var entNo = $(this).data("entno")
		
		var deleteBtn = $(this);
		
		console.log(entNo);
		
		Swal.fire({
			title: "관심 기업를 해지하시겠습니까?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '확인',
            cancelButtonText: '취소',
            reverseButtons: false
		}).then((result) => {
			if(result.value){
				$.ajax({
					url : "/myPage/member/deleteEnt.do",
					type : "post",
					data : {
						entNo : entNo 
					},
					beforeSend : function(xhr){
						xhr.setRequestHeader(header,token);
					},
					success : function(res){
						deleteBtn.closest("tr").remove();
					}
					
				});
			}
		})
	});

	

		
		

	
	$(".selectEnt").on("click",function(e){
		e.preventDefault();
		
		var entNo = $(this).data("entno");
		
		console.log(entNo);

		
		$.ajax({
			url : "/myPage/member/likeEntRecruit.do",
			type : "post",
			data : {
				entNo : entNo
			},
			beforeSend : function(xhr){
				xhr.setRequestHeader(header,token);
			},
			 success: function(res) {
		            if (res && res.length > 0) {
		                console.log(res[0].entNo);
		                
		                // 이미지 소스와 링크 업데이트
		                $("#detail").attr("href", "/ent/detail.do?entNo=" + res[0].entNo);
		                $("#entImg").attr("src", "/main/logodisplay?entNo=" + res[0].entNo);

		                // 기존 테이블 데이터 삭제
		                $("#recruitTable tbody").empty();

		                // 테이블에 새로운 데이터 추가
		                res.forEach(function(item) {
		                    console.log(item.recruitTtl);
		                    var row = '<tr>';
		                    row += '<td style="text-align: start;"><a href="/main/recruitDetail.do?recruitNo=' + item.recruitNo + '&pstnCmmncdNm=' + encodeURIComponent(item.pstnCmmncdNm) + '"';
		                    row += ' class="recruitTtl" style="color: gray; text-decoration: none;"';
		                    row += ' onmouseover="this.style.color=\'#3399FF\';" onmouseout="this.style.color=\'gray\';">';
		                    row += '<span style="font-weight: bold; padding-left: 17px;">' + item.recruitTtl + '</span></a></td>';
		                    row += '<td>';
		                    row += '<button class="btn btn-sm mb-0 recruitBtn" style="background-color: #DCD8FC;"';
		                    row += ' data-recruitno="' + item.recruitNo + '" data-pstncmmncdnm="' + item.pstnCmmncdNm + '"><span style="font-weight: bold;">공고 지원 </span></button>';
		                    row += '</td>';
		                    row += '</tr>';

		                    $("#recruitTable tbody").append(row);
		                });
		            } else {
		                // 데이터가 없을 경우 이미지와 링크 제거 및 메시지 출력
		                $("#detail").attr("href", "#");
		                $("#entImg").attr("src", "");
		                $("#recruitTable tbody").html('<tr id="emptyRecruit"><td colspan="4"><span>채용 공고가 등록되지 않았습니다</span></td></tr>');
		            }
		        },
		        error: function(xhr, status, error) {
		            console.error("Error: " + error);
		            $("#recruitTable tbody").html('<tr><td colspan="4">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>');
		            $("#entImg").attr("src", ""); // 에러가 발생했을 때 이미지 제거
		        }
				
		});
		
		
		
		
		
		
		
		
		
		
		
		
// 		$.ajax({
// 			type : "post",
// 			url : "/ent/modalDetail.do",
// 			data : {
// 				entNo : entNo
// 			},
//             beforeSend: function(xhr) {
//                 xhr.setRequestHeader(header, token);
//             },
// 			success : function(res) {
// 				console.log(res);
				
// 				console.log("ㅇㅁㄴㅇㅁㄴㅇㅁㄴㅇㅁㅇㅁㄴㅇㅁㅇㅁㄴㅇㅁㄴㅇ");

// 				$("#entNo").val(res.entVO.entNo);
// 				$("#entImg").attr("src", "/main/logodisplay?entNo=" + res.entVO.entNo);
// 				$("#detail").attr("href","/ent/detail.do?entNo=" + res.entVO.entNo);

				
				
// 				$("#tksdjq").text("산업");
// 				$("#rldjqrnqns").text("기업구분");
// 				$("#wkqhsrma").text("자본금");
// 				$("#eovy").text("대표");
// 				$("#tkdnjstn").text("사원수");
// 				$("#tjfflqdlf").text("설립일");
// 				$("#wjssusaocnf").text("전년매출");
// 				$("#wnth").text("주소");
				
				
				
// 				$("#ksicNm").text(res.entVO.ksicNm); // 산업	
// 		        $("#entCnt").text(res.entVO.empCnt + " 명"); // 사원수
// 		        $("#bizTypeNm").text(res.entVO.bizTypeNm); // 기업구분
		     	
// 		        // 날짜 문자열 추출
// 		        var dateString = res.entVO.fndnYr;

// 		        // 날짜 형식으로 변환
// 		        var dateObject = new Date(dateString.substring(0, 4), // 연도
// 		                                  dateString.substring(4, 6) - 1, // 월 (0부터 시작하므로 -1)
// 		                                  dateString.substring(6, 8)); // 일

// 		        // 날짜를 원하는 형식으로 형식화
// 		        var formattedDate = dateObject.getFullYear() + '-' + ('0' + (dateObject.getMonth() + 1)).slice(-2) + '-' + ('0' + dateObject.getDate()).slice(-2);

// 		        // 결과를 출력
// 		        $("#fndnYr").text(formattedDate);
		        
// 		        // 3자리마다 ,를 찍기위한 작업
// 		        var number = res.entVO.cptl; // 자본금
// 		        var cptl = number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); 
// 		        $("#cptl").text(cptl + " 원");
		        
// 		        var number1 = res.entVO.entSlsAmt;
// 		        var entSlsAmt = number1.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
// 		        $("#entSlsAmt").text(entSlsAmt + " 원"); // 전년매출
// 		        $("#rprsvNm").text(res.entVO.rprsvNm); // 대표
// 		        $("#address").text(res.entVO.accountAddr1 +  res.entVO.accountAddr2); // 주소
// 			}
// 		})


	});
	

});


$(document).on("click", ".recruitBtn", function() {
    console.log("버튼 클릭됨.");
    
    var accountId = $("#accountId").val();
    var recruitNo = $(this).data("recruitno");
    var pstnCmmncdNm = $(this).data("pstncmmncdnm");

    console.log(accountId);
    console.log("공고 번호:", recruitNo, "포지션 코드:", pstnCmmncdNm);

    var obj = {
        	accountId : accountId,
        	recruitNo : recruitNo,
        	pstnCmmncdNm : pstnCmmncdNm
        }
    	
        $.ajax({
        	type : "post",
        	url : "/like/apply.do",
        	contentType : "application/json; charset=utf-8",
        	data : JSON.stringify(obj),
        	beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success : function(result){
//             	console.log(result);
//             	console.log(result.resumeList);
//             	console.log(result.recruit);
            	
            	
            	var resumeList = result.resumeList;
            	var recruit = result.recruit;
            	
            	var processYn = recruit.processYn;
            	var entUrl = recruit.entUrl;
            	var resumeCheck = recruit.resumeCheck;
            	var applicantCheck = recruit.applicantCheck;
//             	console.log(processYn);
//             	console.log(entUrl);
//             	console.log(resumeCheck);
//             	console.log(applicantCheck);


// 				// 지원내역  확인
				if(applicantCheck == 'Y'){
					Swal.fire(
			      			  '지원내역이 있습니다.'
			      			)
					return;
				}else{
					// 이력서 확인
					if(resumeCheck == 'N'){
						Swal.fire({
							  title: '이력서 미작성 회원입니다. 이동하시겠습니까?',
							  icon: 'warning',
							  showCancelButton: true,
							  confirmButtonText: '확인',
							  cancelButtonText: '취소'
							}).then((result) => {
							  if (result.isConfirmed) {
							    // 확인 버튼을 클릭한 경우
								   $("#resumeForm").submit();
							  } else {
							    // 취소 버튼을 클릭한 경우
							    return;
							  }
							});
					}else{
						
						
						var modalBody = $('#resumeView .modal-body');
						modalBody.empty(); // 모달 내용 초기화
						
// 				        var rsmNo = resume.rsmNo;
// 				        var accountId = resume.accountId;
// 				        var rsmGender = resume.rsmGender;
// 				        var rsmTtl = resume.rsmTtl;
// 				        var rsmCareerYear = resume.rsmCareerYear;
// 				        var rsmRlsYn = resume.rsmRlsYn;
// 				        var rsmPhoto = resume.rsmPhoto;
// 				        var rsmIntroduction = resume.rsmIntroduction;
// 				        var eduEnd = resume.eduEnd;
// 				        var eduNm = resume.eduNm;
// 				        var grade = resume.grade;
// 				        var full = resume.full;
// 				        var rsmMjrNm = resume.rsmMjrNm;
// 				        var rsmMjrCd = resume.rsmMjrCd;
// 				        var rsmNewCareer = resume.rsmNewCareer;
// 				        var eduAcdmcr = resume.eduAcdmcr;

		                // 테이블 생성
						var table = $('<table class="table"><thead><tr><th></th><th>번호</th><th>이름</th><th>보기</th></tr></thead><tbody></tbody></table>');
						modalBody.append(table);
						var tbody = table.find('tbody');
						console.log("resumeList");
						console.log(resumeList);
						$.each(resumeList, function(index, resume) {
							var row = $('<tr>' +
					                  '<td><input class="form-check-input resume-checkbox" type="checkbox" value="' + resume.rsmNo + '" id="resumeCheckbox' + index + '"></td>' +
					                  '<td>' + (index + 1) + '번</td>' +
					                  '<td>' + resume.rsmTtl + '</td>' +
					                  '<td><i class="bi bi-search resume-view-icon" data-rsm-no="' + resume.rsmNo + '"></i></td>' +
					              '</tr>');
					    	tbody.append(row);
						
						    // 체크박스 클릭 이벤트 처리
						    row.find('.resume-checkbox').on('change', function() {
						        if ($(this).is(':checked')) {
// 						        	console.log(resume.rsmNo);
						        	var rsmNo = resume.rsmNo;
// 						            resumePdf(rsmNo);
						            
						            // 다른 체크박스들의 체크를 해제
						            $('.resume-checkbox').not(this).prop('checked', false);
						
						            // 선택된 이력서의 소개를 보여주는 div 생성
// 						            var introductionDiv = $('<div class="resume-introduction">' +
// 						                                        '<h4>' + resume.rsmTtl + '</h4>' +
// // 						                                        '<p>' + resumePdf(rsmNo) + '</p>' +
// 						                                    '</div>');
// 						            var pdfViewer = $('<iframe id="pdfViewer" style="width:100%; height:800px;" src="' + resumePdf(rsmNo) + '"></iframe>');

// 						         	// iframe을 introductionDiv 안에 추가
// 						         	introductionDiv.append(pdfViewer);
						         	// 기존에 선택된 이력서 내용이 있다면 삭제
						            $('.resume-introduction').remove();
// 						            modalBody.append(introductionDiv);
						        } else {
						            // 선택 해제된 경우 해당 이력서의 소개를 보여주는 div 제거
						            $('.resume-introduction').remove();
						        }
						        
						        
						    });
					        // 돋보기 누르면 모달로 이력서 pdf 추가
					        modalBody.find('table').on('click', '.resume-view-icon', function() {
					            var rsmNo = $(this).data('rsm-no');
					            console.log('Clicked resume number:', rsmNo);
					            resumePdf(rsmNo);
					        });
						});
		                
		                // 이력서 선택 모달 열기
		                $('#resumeView').modal('show');
		                
		                
		             	// 모달이 닫힐 때 한 번만 실행되는 이벤트 핸들러
		                $('.site-button').on('click', function () {
		                    // 선택한 이력서 정보를 담을 배열
		                    var selectedResumes = [];
		                    // 선택된 체크박스의 값을 배열에 추가
		                    $('.resume-checkbox:checked').each(function () {
		                        selectedResumes.push($(this).val());
		                    });

		                 	// 선택된 이력서가 없는 경우
		                    if (selectedResumes.length === 0) {
		                        return; // 함수 종료
		                    }
		                    
							var rsmNo = selectedResumes[0];
// 							console.log(rsmNo);
		                    
							// 이력서번호 포함해서 다시 보내기
							var obj = {
									rsmNo: rsmNo,
							        accountId: accountId,
							        recruitNo: recruitNo,
							        pstnCmmncdNm: pstnCmmncdNm
							    };
							
							
							 $.ajax({
						        	type : "post",
						        	url : "/like/applyInsert.do",
						        	contentType : "application/json; charset=utf-8",
						        	data : JSON.stringify(obj),
						        	beforeSend: function(xhr) {
						                xhr.setRequestHeader(header, token);
						            },
						            success : function(result){
// 						            	console.log(result);
						            	
						            	// 프로세스 확인
										if(processYn == "Y"){
						            		location.href = "/main/introForm.do?recruitNo=" + recruitNo + "&pstnCmmncdNm=" + pstnCmmncdNm;
						            	}else{
						            		if (!entUrl.startsWith("http://") && !entUrl.startsWith("https://")) {
						            	        // 상대 URL인 경우, 절대 URL로 변환
						            	        entUrl = "http://" + entUrl;
						            	    }
						            	    window.open(entUrl, "_blank");
						            	}
						            }
						            
							 });
							 
							
		                });
		                
						
					}

				}
            }          
        });
    
    
});
</script>